// src/app/api/ai-chat/route.js - å®Œæ•´ä¿®å¤ç‰ˆ
import { NextResponse } from 'next/server';

// å®‰å…¨ç”Ÿäº§çŸ¥è¯†åº“
// å¤§å¹…ä¼˜åŒ–çš„å®‰å…¨ç”Ÿäº§çŸ¥è¯†åº“
const safetyKnowledge = [
  {
    id: 1,
    category: "å®‰å…¨ç”Ÿäº§æ³•",
    keywords: [
      // æ³•å¾‹æ³•è§„ç›¸å…³
      "å®‰å…¨ç”Ÿäº§æ³•", "æ³•å¾‹", "æ³•è§„", "ä¸»ä½“è´£ä»»", "å®‰å…¨è´£ä»»åˆ¶", "æ³•å¾‹è´£ä»»",
      // åˆ¶åº¦å»ºè®¾ç›¸å…³  
      "å®‰å…¨ç®¡ç†åˆ¶åº¦", "åˆ¶åº¦å»ºç«‹", "åˆ¶åº¦å»ºè®¾", "è§„ç« åˆ¶åº¦", "ç®¡ç†åˆ¶åº¦", "åˆ¶åº¦ä½“ç³»",
      "æ“ä½œè§„ç¨‹", "ä½œä¸šè§„ç¨‹", "å®‰å…¨è§„ç¨‹", "ç®¡ç†è§„ç¨‹", "åˆ¶åº¦å®Œå–„", "åˆ¶åº¦å¥å…¨",
      // è´£ä»»ä½“ç³»ç›¸å…³
      "è´£ä»»åˆ¶", "è´£ä»»ä½“ç³»", "ä¸»è¦è´Ÿè´£äºº", "å®‰å…¨è´£ä»»", "è´£ä»»è½å®", "è´£ä»»åˆ†å·¥",
      "ç»„ç»‡æ¶æ„", "ç®¡ç†ä½“ç³»", "å®‰å…¨ç»„ç»‡", "ç®¡ç†æ¶æ„"
    ],
    content: `ã€Šå®‰å…¨ç”Ÿäº§æ³•ã€‹æ˜¯æˆ‘å›½å®‰å…¨ç”Ÿäº§é¢†åŸŸçš„åŸºæœ¬æ³•å¾‹ï¼Œä¸ºå®‰å…¨ç®¡ç†åˆ¶åº¦å»ºç«‹æä¾›äº†æ³•å¾‹ä¾æ®ã€‚

**å®‰å…¨ç®¡ç†åˆ¶åº¦å»ºç«‹æ­¥éª¤ï¼š**

**1. å»ºç«‹å®‰å…¨ç”Ÿäº§è´£ä»»åˆ¶**
â€¢ æ˜ç¡®ä¸»è¦è´Ÿè´£äººå®‰å…¨èŒè´£
â€¢ åˆ¶å®šå„çº§ç®¡ç†äººå‘˜å®‰å…¨è´£ä»»
â€¢ ç¡®å®šå„å²—ä½å®‰å…¨èŒè´£
â€¢ å»ºç«‹è´£ä»»è€ƒæ ¸æœºåˆ¶

**2. åˆ¶å®šå®‰å…¨ç®¡ç†åˆ¶åº¦**
â€¢ å®‰å…¨ç”Ÿäº§æŠ•å…¥ç®¡ç†åˆ¶åº¦
â€¢ å®‰å…¨æ•™è‚²åŸ¹è®­åˆ¶åº¦  
â€¢ å®‰å…¨æ£€æŸ¥å’Œéšæ‚£æ’æŸ¥åˆ¶åº¦
â€¢ åŠ³åŠ¨é˜²æŠ¤ç”¨å“ç®¡ç†åˆ¶åº¦
â€¢ å®‰å…¨è®¾æ–½è®¾å¤‡ç®¡ç†åˆ¶åº¦

**3. ç¼–åˆ¶æ“ä½œè§„ç¨‹**
â€¢ å„å·¥ç§å®‰å…¨æ“ä½œè§„ç¨‹
â€¢ è®¾å¤‡å®‰å…¨æ“ä½œè§„ç¨‹
â€¢ ç‰¹æ®Šä½œä¸šå®‰å…¨è§„ç¨‹
â€¢ åº”æ€¥å¤„ç½®æ“ä½œè§„ç¨‹

**4. å»ºç«‹ç®¡ç†æ¡£æ¡ˆ**
â€¢ åˆ¶åº¦å‘å¸ƒå’ŒåŸ¹è®­è®°å½•
â€¢ åˆ¶åº¦æ‰§è¡Œæ£€æŸ¥è®°å½•
â€¢ åˆ¶åº¦ä¿®è®¢å®Œå–„è®°å½•

**åˆ¶åº¦å»ºè®¾è¦ç‚¹ï¼š**
â€¢ ç»“åˆä¼ä¸šå®é™…æƒ…å†µ
â€¢ ç¬¦åˆæ³•å¾‹æ³•è§„è¦æ±‚
â€¢ æ“ä½œæ€§å¼ºï¼Œä¾¿äºæ‰§è¡Œ
â€¢ å®šæœŸè¯„ä¼°å’Œå®Œå–„`
  },
  {
    id: 2,
    category: "é£é™©è¯„ä¼°",
    keywords: [
      // é£é™©è¯„ä¼°ç›¸å…³
      "é£é™©è¯„ä¼°", "é£é™©è¯†åˆ«", "é£é™©åˆ†æ", "é£é™©è¯„ä»·", "é£é™©ç®¡ç†",
      // é£é™©æ§åˆ¶ç›¸å…³
      "é£é™©æ§åˆ¶", "é£é™©ç®¡æ§", "ç®¡æ§æªæ–½", "æ§åˆ¶æªæ–½", "é£é™©é˜²æ§", "é£é™©é¢„é˜²",
      "é£é™©ç®¡æ§æªæ–½", "ç®¡æ§æ–¹æ³•", "æ§åˆ¶æ–¹æ³•", "é˜²æ§æ‰‹æ®µ", "é˜²èŒƒæªæ–½",
      // è¯„ä¼°æ–¹æ³•ç›¸å…³
      "LEC", "é£é™©çŸ©é˜µ", "é£é™©ç­‰çº§", "HAZOP", "FMEA", "è¯„ä¼°æ–¹æ³•",
      "é£é™©çº§åˆ«", "é£é™©åˆ†çº§", "å±é™©ç­‰çº§", "é£é™©ç¨‹åº¦"
    ],
    content: `é£é™©è¯„ä¼°æ˜¯å®‰å…¨ç®¡ç†çš„æ ¸å¿ƒç¯èŠ‚ï¼Œé£é™©ç®¡æ§æªæ–½æ˜¯ç¡®ä¿å®‰å…¨çš„å…³é”®ã€‚

**é£é™©ç®¡æ§æªæ–½ä½“ç³»ï¼š**

**1. å·¥ç¨‹æŠ€æœ¯æªæ–½ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰**
â€¢ æœ¬è´¨å®‰å…¨è®¾è®¡ - ä»æºå¤´æ¶ˆé™¤å±é™©
â€¢ å®‰å…¨é˜²æŠ¤è£…ç½® - å®‰å…¨é˜€ã€é˜²çˆ†è£…ç½®ç­‰
â€¢ éš”ç¦»é˜²æŠ¤æªæ–½ - éš”ç¦»å¢™ã€é˜²æŠ¤æ ç­‰
â€¢ è‡ªåŠ¨æ§åˆ¶ç³»ç»Ÿ - è‡ªåŠ¨ç›‘æµ‹ã€æŠ¥è­¦ã€è”é”

**2. ç®¡ç†æ§åˆ¶æªæ–½**
â€¢ å®‰å…¨ç®¡ç†åˆ¶åº¦å»ºç«‹å’Œæ‰§è¡Œ
â€¢ å®‰å…¨æ“ä½œè§„ç¨‹åˆ¶å®šå’ŒåŸ¹è®­
â€¢ å®‰å…¨æ£€æŸ¥å’Œéšæ‚£æ’æŸ¥
â€¢ ä½œä¸šè®¸å¯å’Œå®¡æ‰¹åˆ¶åº¦
â€¢ åº”æ€¥é¢„æ¡ˆåˆ¶å®šå’Œæ¼”ç»ƒ

**3. åŸ¹è®­æ•™è‚²æªæ–½**
â€¢ å®‰å…¨æ„è¯†æ•™è‚²æå‡
â€¢ æŠ€èƒ½åŸ¹è®­å’Œèµ„æ ¼è®¤è¯
â€¢ åº”æ€¥å¤„ç½®èƒ½åŠ›åŸ¹è®­
â€¢ å®‰å…¨æ–‡åŒ–å»ºè®¾

**4. ä¸ªä½“é˜²æŠ¤æªæ–½ï¼ˆæœ€åé˜²çº¿ï¼‰**
â€¢ ä¸ªäººé˜²æŠ¤è£…å¤‡é…å¤‡
â€¢ é˜²æŠ¤ç”¨å“æ­£ç¡®ä½¿ç”¨
â€¢ å®šæœŸæ£€æŸ¥å’Œæ›´æ¢

**é£é™©ç®¡æ§åŸåˆ™ï¼š**
â€¢ é¢„é˜²ä¸ºä¸»ï¼Œæºå¤´æ²»ç†
â€¢ åˆ†çº§ç®¡æ§ï¼Œé‡ç‚¹çªå‡º
â€¢ åŠ¨æ€è°ƒæ•´ï¼ŒæŒç»­æ”¹è¿›
â€¢ å…¨å‘˜å‚ä¸ï¼Œè´£ä»»åˆ°äºº

**ç®¡æ§æ•ˆæœè¯„ä¼°ï¼š**
â€¢ å®šæœŸè¯„ä¼°ç®¡æ§æªæ–½æœ‰æ•ˆæ€§
â€¢ æ ¹æ®è¯„ä¼°ç»“æœè°ƒæ•´æªæ–½
â€¢ å»ºç«‹ç®¡æ§æªæ–½æ¡£æ¡ˆè®°å½•`
  },
  {
    id: 3,
    category: "åº”æ€¥ç®¡ç†",
    keywords: [
      "åº”æ€¥é¢„æ¡ˆ", "åº”æ€¥æ¼”ç»ƒ", "åº”æ€¥å“åº”", "äº‹æ•…å¤„ç½®", "åº”æ€¥æ•‘æ´", "åº”æ€¥ç®¡ç†",
      "åº”æ€¥å‡†å¤‡", "åº”æ€¥å¤„ç†", "äº‹æ•…åº”æ€¥", "ç´§æ€¥å“åº”", "æ•‘æ´é¢„æ¡ˆ", "å¤„ç½®æ–¹æ¡ˆ",
      "åº”æ€¥ä½“ç³»", "åº”æ€¥æœºåˆ¶", "åº”æ€¥ç¨‹åº", "åº”æ€¥æµç¨‹", "åº”æ€¥æŒ‡æŒ¥", "åº”æ€¥ç»„ç»‡"
    ],
    content: `åº”æ€¥ç®¡ç†æ˜¯å¯¹çªå‘å®‰å…¨äº‹æ•…çš„é¢„é˜²ã€å‡†å¤‡ã€å“åº”å’Œæ¢å¤çš„å…¨è¿‡ç¨‹ç®¡ç†ã€‚

**åº”æ€¥é¢„æ¡ˆä½“ç³»ï¼š**
â€¢ **ç»¼åˆåº”æ€¥é¢„æ¡ˆ** - ä¼ä¸šæ€»ä½“åº”æ€¥ç­–ç•¥å’Œç¨‹åº
â€¢ **ä¸“é¡¹åº”æ€¥é¢„æ¡ˆ** - é’ˆå¯¹ç‰¹å®šé£é™©çš„ä¸“é—¨é¢„æ¡ˆ
â€¢ **ç°åœºå¤„ç½®æ–¹æ¡ˆ** - å…·ä½“ä½œä¸šåœºæ‰€çš„åº”æ€¥å¤„ç½®

**åº”æ€¥é¢„æ¡ˆè¦ç´ ï¼š**
1. **åº”æ€¥ç»„ç»‡æœºæ„** - æŒ‡æŒ¥éƒ¨ã€å„å·¥ä½œç»„èŒè´£
2. **é¢„è­¦æœºåˆ¶** - ç›‘æµ‹ã€é¢„è­¦ã€ä¿¡æ¯æŠ¥å‘Š
3. **åº”æ€¥å“åº”ç¨‹åº** - åˆ†çº§å“åº”ã€å¤„ç½®æµç¨‹
4. **åº”æ€¥ä¿éšœ** - äººå‘˜ã€è£…å¤‡ã€èµ„é‡‘ã€æŠ€æœ¯ä¿éšœ
5. **åæœŸå¤„ç½®** - å–„åå¤„ç†ã€äº‹æ•…è°ƒæŸ¥ã€æ¢å¤é‡å»º

**åº”æ€¥æ¼”ç»ƒè¦æ±‚ï¼š**
â€¢ **é¢‘æ¬¡**ï¼šç»¼åˆæ¼”ç»ƒæ¯å¹´è‡³å°‘1æ¬¡ï¼Œä¸“é¡¹æ¼”ç»ƒæ¯åŠå¹´è‡³å°‘1æ¬¡
â€¢ **ç±»å‹**ï¼šæ¡Œé¢æ¼”ç»ƒã€åŠŸèƒ½æ¼”ç»ƒã€å…¨é¢æ¼”ç»ƒ
â€¢ **è¯„ä¼°**ï¼šæ¼”ç»ƒæ•ˆæœè¯„ä¼°ï¼ŒåŠæ—¶ä¿®è®¢é¢„æ¡ˆ

**åº”æ€¥å“åº”çº§åˆ«ï¼š**
â€¢ â… çº§(ç‰¹åˆ«é‡å¤§)ï¼šæ­»äº¡30äººä»¥ä¸Šæˆ–ç›´æ¥æŸå¤±1äº¿å…ƒä»¥ä¸Š
â€¢ â…¡çº§(é‡å¤§)ï¼šæ­»äº¡10-29äººæˆ–ç›´æ¥æŸå¤±5000ä¸‡-1äº¿å…ƒ
â€¢ â…¢çº§(è¾ƒå¤§)ï¼šæ­»äº¡3-9äººæˆ–ç›´æ¥æŸå¤±1000ä¸‡-5000ä¸‡å…ƒ
â€¢ â…£çº§(ä¸€èˆ¬)ï¼šæ­»äº¡1-2äººæˆ–ç›´æ¥æŸå¤±1000ä¸‡å…ƒä»¥ä¸‹`
  },
  {
    id: 4,
    category: "éšæ‚£æ’æŸ¥",
    keywords: [
      "éšæ‚£æ’æŸ¥", "å®‰å…¨æ£€æŸ¥", "éšæ‚£æ²»ç†", "åŒé‡é¢„é˜²", "éšæ‚£åˆ†çº§",
      "æ’æŸ¥åˆ¶åº¦", "æ£€æŸ¥åˆ¶åº¦", "éšæ‚£æ•´æ”¹", "å®‰å…¨å·¡æŸ¥", "ç°åœºæ£€æŸ¥",
      "éšæ‚£ç®¡ç†", "æ’æŸ¥è¦ç‚¹", "æ£€æŸ¥è¦ç‚¹", "éšæ‚£è¯†åˆ«", "é—®é¢˜æ’æŸ¥"
    ],
    content: `éšæ‚£æ’æŸ¥æ²»ç†æ˜¯é¢„é˜²äº‹æ•…çš„é‡è¦æ‰‹æ®µï¼Œé€šè¿‡ç³»ç»Ÿæ’æŸ¥å’ŒåŠæ—¶æ²»ç†ï¼Œæ¶ˆé™¤å®‰å…¨éšæ‚£ã€‚

**éšæ‚£æ’æŸ¥åˆ¶åº¦ï¼š**
â€¢ **æ—¥å¸¸æ’æŸ¥** - å²—ä½å‘˜å·¥ç­å‰ç­ä¸­ç­åæ£€æŸ¥
â€¢ **å®šæœŸæ’æŸ¥** - ä¸“ä¸šäººå‘˜å‘¨æ£€æŸ¥ã€æœˆæ£€æŸ¥
â€¢ **ä¸“é¡¹æ’æŸ¥** - é’ˆå¯¹ç‰¹å®šæ—¶æœŸã€ç‰¹å®šé£é™©çš„æ£€æŸ¥
â€¢ **ç»¼åˆæ’æŸ¥** - å…¨é¢ç³»ç»Ÿçš„å®‰å…¨å¤§æ£€æŸ¥

**éšæ‚£åˆ†çº§æ ‡å‡†ï¼š**
â€¢ **é‡å¤§éšæ‚£** - å¯èƒ½å¯¼è‡´é‡å¤§äº‹æ•…ï¼Œéœ€ç«‹å³åœäº§æ²»ç†
â€¢ **ä¸€èˆ¬éšæ‚£** - å¯èƒ½å¯¼è‡´ä¸€èˆ¬äº‹æ•…ï¼Œéœ€é™æœŸæ²»ç†

**æ’æŸ¥æ²»ç†æµç¨‹ï¼š**
1. **æ’æŸ¥å‘ç°** - å»ºç«‹æ’æŸ¥æ¸…å•ï¼Œå…¨é¢ç³»ç»Ÿæ’æŸ¥
2. **ç™»è®°å»ºæ¡£** - éšæ‚£ä¿¡æ¯è®°å½•ã€åˆ†ç±»åˆ†çº§
3. **æ²»ç†æ•´æ”¹** - åˆ¶å®šæ–¹æ¡ˆï¼Œè½å®æªæ–½ï¼Œæ¶ˆé™¤éšæ‚£
4. **éªŒæ”¶é”€å·** - æ²»ç†å®ŒæˆåéªŒæ”¶ï¼Œç¡®è®¤æ¶ˆé™¤
5. **ä¿¡æ¯æŠ¥é€** - æŒ‰è§„å®šæŠ¥é€éšæ‚£ä¿¡æ¯

**åŒé‡é¢„é˜²æœºåˆ¶ï¼š**
â€¢ **é£é™©åˆ†çº§ç®¡æ§** - è¶…å‰é˜²èŒƒï¼Œä»æºå¤´é¢„é˜²
â€¢ **éšæ‚£æ’æŸ¥æ²»ç†** - ç²¾å‡†æ²»ç†ï¼Œæœ‰æ•ˆåŒ–è§£é£é™©

**æ£€æŸ¥è¦ç‚¹ï¼š**
â€¢ äººçš„ä¸å®‰å…¨è¡Œä¸ºï¼šè¿ç« ä½œä¸šã€ä¸å½“æ“ä½œ
â€¢ ç‰©çš„ä¸å®‰å…¨çŠ¶æ€ï¼šè®¾å¤‡ç¼ºé™·ã€é˜²æŠ¤å¤±æ•ˆ
â€¢ ç¯å¢ƒä¸å®‰å…¨å› ç´ ï¼šä½œä¸šç¯å¢ƒã€æ°”è±¡æ¡ä»¶
â€¢ ç®¡ç†ç¼ºé™·ï¼šåˆ¶åº¦ä¸å®Œå–„ã€åŸ¹è®­ä¸åˆ°ä½`
  },
  {
    id: 5,
    category: "å®‰å…¨åŸ¹è®­",
    keywords: [
      "å®‰å…¨åŸ¹è®­", "å®‰å…¨æ•™è‚²", "ä¸‰çº§æ•™è‚²", "ç‰¹ç§ä½œä¸š", "å®‰å…¨æ„è¯†",
      "åŸ¹è®­åˆ¶åº¦", "æ•™è‚²åˆ¶åº¦", "åŸ¹è®­è®¡åˆ’", "æ•™è‚²è®¡åˆ’", "åŸ¹è®­ç®¡ç†",
      "å²—å‰åŸ¹è®­", "åœ¨å²—åŸ¹è®­", "è½¬å²—åŸ¹è®­", "å®‰å…¨å­¦ä¹ ", "æŠ€èƒ½åŸ¹è®­"
    ],
    content: `å®‰å…¨åŸ¹è®­æ•™è‚²æ˜¯æé«˜ä»ä¸šäººå‘˜å®‰å…¨ç´ è´¨ï¼Œé˜²èŒƒäº‹æ•…å‘ç”Ÿçš„é‡è¦æ‰‹æ®µã€‚

**ä¸‰çº§å®‰å…¨æ•™è‚²ï¼š**
â€¢ **å‚çº§æ•™è‚²** - å®‰å…¨æ³•è§„ã€ä¼ä¸šå®‰å…¨åˆ¶åº¦ã€åŸºæœ¬å®‰å…¨çŸ¥è¯†(ä¸å°‘äº24å­¦æ—¶)
â€¢ **è½¦é—´çº§æ•™è‚²** - è½¦é—´å®‰å…¨åˆ¶åº¦ã€ä½œä¸šç¯å¢ƒã€å±é™©å› ç´ (ä¸å°‘äº16å­¦æ—¶)  
â€¢ **ç­ç»„çº§æ•™è‚²** - å²—ä½æ“ä½œè§„ç¨‹ã€å®‰å…¨æŠ€èƒ½ã€ä¸ªä½“é˜²æŠ¤(ä¸å°‘äº8å­¦æ—¶)

**ç‰¹ç§ä½œä¸šäººå‘˜è¦æ±‚ï¼š**
â€¢ **èŒƒå›´**ï¼šç”µå·¥ã€ç„Šå·¥ã€é«˜å¤„ä½œä¸šã€å±é™©åŒ–å­¦å“ç­‰
â€¢ **è¯ä¹¦**ï¼šå¿…é¡»æŒè¯ä¸Šå²—ï¼Œå®šæœŸå¤å®¡
â€¢ **åŸ¹è®­**ï¼šåˆè®­ä¸å°‘äº140å­¦æ—¶ï¼Œå¤è®­ä¸å°‘äº20å­¦æ—¶
â€¢ **è€ƒæ ¸**ï¼šç†è®ºè€ƒè¯•+å®é™…æ“ä½œï¼Œ80åˆ†ä»¥ä¸Šåˆæ ¼

**ä¸»è¦è´Ÿè´£äººå’Œå®‰å…¨ç®¡ç†äººå‘˜ï¼š**
â€¢ **åˆæ¬¡åŸ¹è®­**ï¼šä¸å°‘äº32å­¦æ—¶
â€¢ **ç»§ç»­æ•™è‚²**ï¼šæ¯å¹´ä¸å°‘äº12å­¦æ—¶
â€¢ **å†…å®¹**ï¼šå®‰å…¨æ³•è§„ã€ç®¡ç†çŸ¥è¯†ã€åº”æ€¥å¤„ç½®ç­‰

**ä¸€èˆ¬ä»ä¸šäººå‘˜ï¼š**
â€¢ **åˆæ¬¡åŸ¹è®­**ï¼šä¸å°‘äº20å­¦æ—¶
â€¢ **ç»§ç»­æ•™è‚²**ï¼šæ¯å¹´ä¸å°‘äº8å­¦æ—¶
â€¢ **æ¢å²—åŸ¹è®­**ï¼šä¸å°‘äº20å­¦æ—¶

**åŸ¹è®­æ¡£æ¡ˆç®¡ç†ï¼š**
â€¢ åŸ¹è®­è®¡åˆ’ã€æ•™æã€è¯¾ä»¶
â€¢ å‚è®­äººå‘˜åå†Œã€æˆç»©è®°å½•
â€¢ åŸ¹è®­è¯ä¹¦ã€åˆæ ¼è¯æ˜
â€¢ åŸ¹è®­æ•ˆæœè¯„ä¼°è®°å½•

**æ–°å·¥è‰ºã€æ–°æŠ€æœ¯ã€æ–°è®¾å¤‡åŸ¹è®­ï¼š**
â€¢ é‡‡ç”¨æ–°å·¥è‰ºå‰å¿…é¡»è¿›è¡Œä¸“é—¨åŸ¹è®­
â€¢ åŸ¹è®­å†…å®¹åŒ…æ‹¬æŠ€æœ¯è¦æ±‚ã€æ“ä½œè¦ç‚¹ã€å®‰å…¨æ³¨æ„äº‹é¡¹
â€¢ ç»è€ƒæ ¸åˆæ ¼åæ–¹å¯ä¸Šå²—æ“ä½œ`
  },
  {
    id: 6,
    category: "é‡å¤§å±é™©æº",
    keywords: [
      "é‡å¤§å±é™©æº", "å±é™©æºè¾¨è¯†", "é‡å¤§å±é™©æºç›‘æ§", "ä¸´ç•Œé‡", "å±é™©åŒ–å­¦å“",
      "å±é™©æºè¯†åˆ«", "å±é™©æºç®¡ç†", "é‡å¤§å±é™©æºç®¡ç†", "å±é™©æºè¯„ä¼°", "å±é™©æºåˆ†çº§"
    ],
    content: `é‡å¤§å±é™©æºæ˜¯æŒ‡é•¿æœŸæˆ–ä¸´æ—¶ç”Ÿäº§ã€æ¬è¿ã€ä½¿ç”¨æˆ–è´®å­˜å±é™©ç‰©å“ï¼Œä¸”å±é™©ç‰©å“çš„æ•°é‡ç­‰äºæˆ–è¶…è¿‡ä¸´ç•Œé‡çš„å•å…ƒã€‚

**é‡å¤§å±é™©æºè¾¨è¯†ï¼š**
â€¢ **åˆ¤å®šæ ‡å‡†**ï¼šå±é™©ç‰©å“æ•°é‡â‰¥ä¸´ç•Œé‡
â€¢ **è®¡ç®—æ–¹æ³•**ï¼šâˆ‘(qâ‚/Qâ‚ + qâ‚‚/Qâ‚‚ + ... + qâ‚™/Qâ‚™) â‰¥ 1

**åˆ†çº§æ ‡å‡†ï¼š**
â€¢ **ä¸€çº§**ï¼šRâ‰¥100(æé«˜å±é™©)
â€¢ **äºŒçº§**ï¼š100>Râ‰¥50(é«˜åº¦å±é™©)  
â€¢ **ä¸‰çº§**ï¼š50>Râ‰¥10(ä¸­åº¦å±é™©)
â€¢ **å››çº§**ï¼šR<10(ä¸€èˆ¬å±é™©)

**å®‰å…¨ç®¡ç†è¦æ±‚ï¼š**
1. **å»ºç«‹ç®¡ç†åˆ¶åº¦** - å®‰å…¨ç®¡ç†åˆ¶åº¦ã€æ“ä½œè§„ç¨‹
2. **é…å¤‡å®‰å…¨è®¾æ–½** - ç›‘æµ‹ã€æŠ¥è­¦ã€è”é”ã€ç´§æ€¥åˆ‡æ–­ç­‰
3. **åˆ¶å®šåº”æ€¥é¢„æ¡ˆ** - ä¸“é¡¹åº”æ€¥é¢„æ¡ˆå’Œç°åœºå¤„ç½®æ–¹æ¡ˆ
4. **å®šæœŸæ£€æµ‹è¯„ä¼°** - æ¯ä¸‰å¹´è¿›è¡Œä¸€æ¬¡å®‰å…¨è¯„ä»·
5. **å¤‡æ¡ˆç™»è®°** - å‘å®‰ç›‘éƒ¨é—¨å¤‡æ¡ˆï¼Œè·å¾—ç™»è®°è¯æ˜

**ç›‘æ§æªæ–½ï¼š**
â€¢ **å®æ—¶ç›‘æ§** - æ¸©åº¦ã€å‹åŠ›ã€æ¶²ä½ã€æµ“åº¦ç­‰å…³é”®å‚æ•°
â€¢ **æŠ¥è­¦ç³»ç»Ÿ** - è¶…é™è‡ªåŠ¨æŠ¥è­¦ï¼ŒåŠæ—¶é¢„è­¦
â€¢ **è§†é¢‘ç›‘æ§** - é‡ç‚¹éƒ¨ä½å…¨å¤©å€™ç›‘æ§
â€¢ **å·¡å›æ£€æŸ¥** - å®šæœŸäººå·¥å·¡æ£€ï¼Œè®°å½•å¼‚å¸¸æƒ…å†µ

**å¸¸è§å±é™©ç‰©å“ä¸´ç•Œé‡ï¼š**
â€¢ æ±½æ²¹ï¼š5000å¨
â€¢ æŸ´æ²¹ï¼š5000å¨  
â€¢ æ¶²æ°¨ï¼š10å¨
â€¢ æ¶²æ°¯ï¼š5å¨
â€¢ ä¸™çƒ·ï¼š50å¨
â€¢ æ°¢æ°”ï¼š5å¨

**åº”æ€¥å¤„ç½®è¦ç‚¹ï¼š**
â€¢ è¿…é€Ÿåˆ‡æ–­æ³„æ¼æºï¼Œæ§åˆ¶æ³„æ¼æ‰©æ•£
â€¢ ç«‹å³å¯åŠ¨åº”æ€¥é¢„æ¡ˆï¼Œç–æ•£ç›¸å…³äººå‘˜
â€¢ åŠæ—¶æŠ¥å‘Šåº”æ€¥ç®¡ç†éƒ¨é—¨
â€¢ é‡‡å–æœ‰æ•ˆæªæ–½ï¼Œé˜²æ­¢äº‹æ•…æ‰©å¤§`
  }
];
// æ™ºèƒ½åŒ¹é…ç®—æ³•
function findBestMatch(question) {
  let bestMatches = [];
  const questionLower = question.toLowerCase();
  
  for (const knowledge of safetyKnowledge) {
    let score = 0;
    
    // å…³é”®è¯åŒ¹é…
    for (const keyword of knowledge.keywords) {
      if (questionLower.includes(keyword)) {
        score += 10;
      }
    }
    
    // åˆ†ç±»åŒ¹é…
    if (questionLower.includes(knowledge.category)) {
      score += 5;
    }
    
    // æ¨¡ç³ŠåŒ¹é…
    const questionChars = questionLower.split('');
    for (const char of questionChars) {
      if (char.length > 0) {
        for (const keyword of knowledge.keywords) {
          if (keyword.includes(char)) {
            score += 0.5;
          }
        }
      }
    }
    
    if (score > 0) {
      bestMatches.push({ 
        knowledge, 
        score,
        matchInfo: `åŒ¹é…åˆ†æ•°: ${score.toFixed(1)}, ç±»åˆ«: ${knowledge.category}`
      });
    }
  }
  
  bestMatches.sort((a, b) => b.score - a.score);
  return bestMatches.slice(0, 2);
}

// ç”Ÿæˆå›ç­”
function generateAnswer(question, matches) {
  const questionLower = question.toLowerCase();
  
  // å¦‚æœæœ‰åŒ¹é…é¡¹ï¼Œè¿”å›æœ€ä½³åŒ¹é…
  if (matches.length > 0 && matches[0].score >= 2) {
    const bestMatch = matches[0];
    const knowledge = bestMatch.knowledge;
    
    let answer = `å…³äº"${question}"çš„ä¸“ä¸šå›ç­”ï¼š\n\n`;
    answer += knowledge.content;
    answer += `\n\nğŸ“‹ **ç›¸å…³è¦ç‚¹æé†’ï¼š**\n`;
    answer += `â€¢ æ‰€å±é¢†åŸŸï¼š${knowledge.category}\n`;
    answer += `â€¢ åŒ¹é…åº¦ï¼š${bestMatch.score.toFixed(1)}åˆ†\n`;
    
    if (matches.length > 1) {
      answer += `â€¢ ç›¸å…³é¢†åŸŸï¼š${matches[1].knowledge.category}\n`;
    }
    
    answer += `\nğŸ’¡ **å®æ–½å»ºè®®ï¼š**\n`;
    answer += `â€¢ ç»“åˆä¼ä¸šå®é™…æƒ…å†µåˆ¶å®šå…·ä½“æªæ–½\n`;
    answer += `â€¢ å®šæœŸæ£€æŸ¥å’Œæ›´æ–°ç›¸å…³åˆ¶åº¦\n`;
    answer += `â€¢ åŠ å¼ºåŸ¹è®­ï¼Œæé«˜å‘˜å·¥è®¤çŸ¥æ°´å¹³\n`;
    answer += `\nï¼ˆå½“å‰ä¸ºå¢å¼ºæ¼”ç¤ºæ¨¡å¼ï¼ŒåŸºäºä¸“ä¸šå®‰å…¨ç”Ÿäº§çŸ¥è¯†åº“ï¼‰`;
    
    return {
      answer,
      relatedTopics: [knowledge.category, ...(matches.length > 1 ? [matches[1].knowledge.category] : [])],
      matchScore: bestMatch.score
    };
  }
  
  // æ™ºèƒ½å…œåº•å›ç­”
  let smartAnswer = `æ„Ÿè°¢æ‚¨çš„æé—®ï¼š"${question}"ã€‚\n\n`;
  
  if (questionLower.includes('å¦‚ä½•') || questionLower.includes('æ€ä¹ˆ') || questionLower.includes('æ€æ ·')) {
    smartAnswer += `æˆ‘ç†è§£æ‚¨æƒ³äº†è§£å…·ä½“çš„æ“ä½œæ–¹æ³•ã€‚åŸºäºå®‰å…¨ç”Ÿäº§æœ€ä½³å®è·µï¼Œæˆ‘å»ºè®®æ‚¨ï¼š\n\n`;
    smartAnswer += `**åŸºæœ¬åŸåˆ™ï¼š**\n`;
    smartAnswer += `â€¢ éµå¾ª"å®‰å…¨ç¬¬ä¸€ã€é¢„é˜²ä¸ºä¸»ã€ç»¼åˆæ²»ç†"æ–¹é’ˆ\n`;
    smartAnswer += `â€¢ å»ºç«‹å¥å…¨å®‰å…¨ç”Ÿäº§è´£ä»»åˆ¶\n`;
    smartAnswer += `â€¢ å®šæœŸå¼€å±•å®‰å…¨æ£€æŸ¥å’Œéšæ‚£æ’æŸ¥\n`;
    smartAnswer += `â€¢ åŠ å¼ºå®‰å…¨æ•™è‚²åŸ¹è®­\n\n`;
  } else if (questionLower.includes('æ˜¯ä»€ä¹ˆ') || questionLower.includes('ä»€ä¹ˆæ˜¯')) {
    smartAnswer += `è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åŸºç¡€æ¦‚å¿µé—®é¢˜ã€‚åœ¨å®‰å…¨ç”Ÿäº§é¢†åŸŸï¼š\n\n`;
    smartAnswer += `**æ ¸å¿ƒè¦ç‚¹ï¼š**\n`;
    smartAnswer += `â€¢ å®‰å…¨ç”Ÿäº§æ˜¯ä¿æŠ¤äººæ°‘ç”Ÿå‘½è´¢äº§å®‰å…¨çš„é‡è¦å·¥ä½œ\n`;
    smartAnswer += `â€¢ éœ€è¦éµå¾ªç›¸å…³æ³•å¾‹æ³•è§„å’Œæ ‡å‡†è§„èŒƒ\n`;
    smartAnswer += `â€¢ ä¼ä¸šæ‰¿æ‹…å®‰å…¨ç”Ÿäº§ä¸»ä½“è´£ä»»\n`;
    smartAnswer += `â€¢ æŒç»­æ”¹è¿›å’Œé£é™©ç®¡æ§æ˜¯å…³é”®\n\n`;
  } else {
    smartAnswer += `åŸºäºå®‰å…¨ç”Ÿäº§ä¸“ä¸šçŸ¥è¯†ï¼Œä¸ºæ‚¨æä¾›ç›¸å…³æŒ‡å¯¼ï¼š\n\n`;
    smartAnswer += `**é€šç”¨å®‰å…¨åŸåˆ™ï¼š**\n`;
    smartAnswer += `â€¢ é¢„é˜²ä¸ºä¸»ï¼Œé˜²æ‚£äºæœªç„¶\n`;
    smartAnswer += `â€¢ å…¨å‘˜å‚ä¸ï¼Œå…±åŒç»´æŠ¤å®‰å…¨\n`;
    smartAnswer += `â€¢ æŒç»­æ”¹è¿›ï¼Œä¸æ–­æå‡å®‰å…¨æ°´å¹³\n`;
    smartAnswer += `â€¢ ä¾æ³•åˆè§„ï¼Œä¸¥æ ¼æ‰§è¡Œæ ‡å‡†\n\n`;
  }
  
  smartAnswer += `**æˆ‘çš„ä¸“ä¸šçŸ¥è¯†åº“æ¶µç›–ï¼š**\n`;
  smartAnswer += `â€¢ å®‰å…¨ç”Ÿäº§æ³•å¾‹æ³•è§„  â€¢ é£é™©è¯„ä¼°ä¸ç®¡æ§\nâ€¢ åº”æ€¥ç®¡ç†  â€¢ éšæ‚£æ’æŸ¥æ²»ç†\nâ€¢ å®‰å…¨æ•™è‚²åŸ¹è®­  â€¢ é‡å¤§å±é™©æºç®¡ç†\n\n`;
  
  smartAnswer += `ğŸ’¡ **å»ºè®®ï¼š** æ‚¨å¯ä»¥å°è¯•è¯¢é—®ä¸Šè¿°å…·ä½“é¢†åŸŸçš„ç›¸å…³å†…å®¹ï¼Œæˆ‘å°†ä¸ºæ‚¨æä¾›æ›´å‡†ç¡®çš„ä¸“ä¸šæŒ‡å¯¼ã€‚`;
  smartAnswer += `\n\nï¼ˆå½“å‰ä¸ºå¢å¼ºæ¼”ç¤ºæ¨¡å¼ï¼ŒæŒç»­å­¦ä¹ ä¼˜åŒ–ä¸­ï¼‰`;
  
  return {
    answer: smartAnswer,
    relatedTopics: ["å®‰å…¨ç”Ÿäº§æ³•", "é£é™©è¯„ä¼°", "åº”æ€¥ç®¡ç†", "å®‰å…¨åŸ¹è®­"],
    matchScore: 1
  };
}

// å¤„ç†POSTè¯·æ±‚
export async function POST(request) {
  try {
    const { question } = await request.json();

    if (!question || question.trim().length === 0) {
      return NextResponse.json({
        success: false,
        error: 'é—®é¢˜ä¸èƒ½ä¸ºç©ºï¼Œè¯·è¾“å…¥æ‚¨çš„å®‰å…¨ç”Ÿäº§ç›¸å…³é—®é¢˜'
      }, { status: 400 });
    }

    console.log('æ”¶åˆ°é—®é¢˜:', question);

    // æ™ºèƒ½åŒ¹é…å’Œå›ç­”
    const matches = findBestMatch(question);
    console.log(`æ‰¾åˆ° ${matches.length} ä¸ªåŒ¹é…é¡¹:`, matches.map(m => m.matchInfo));

    // æ¨¡æ‹Ÿæ€è€ƒæ—¶é—´
    await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));

    const result = generateAnswer(question, matches);
    
    console.log(`ç”Ÿæˆå›ç­”ï¼Œé•¿åº¦: ${result.answer.length}, åŒ¹é…åˆ†æ•°: ${result.matchScore}`);

    return NextResponse.json({
      success: true,
      answer: result.answer,
      relatedTopics: result.relatedTopics,
      timestamp: new Date().toISOString(),
      tokensUsed: Math.floor(result.answer.length / 4),
      mode: "enhanced_demo",
      matchScore: result.matchScore
    });

  } catch (error) {
    console.error('AI Chat APIé”™è¯¯:', error);
    return NextResponse.json({
      success: false,
      error: 'æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å›ç­”ï¼Œè¯·ç¨åå†è¯•'
    }, { status: 500 });
  }
}

// å¤„ç†GETè¯·æ±‚
export async function GET() {
  return NextResponse.json({
    message: "AIèŠå¤©API - å¢å¼ºæ¼”ç¤ºæ¨¡å¼",
    features: [
      "æ™ºèƒ½å…³é”®è¯åŒ¹é…",
      "6å¤§å®‰å…¨é¢†åŸŸçŸ¥è¯†åº“", 
      "è¯¦ç»†ä¸“ä¸šå›ç­”",
      "ç›¸å…³ä¸»é¢˜æ¨è",
      "åŒ¹é…åº¦è¯„åˆ†"
    ],
    knowledgeAreas: safetyKnowledge.map(k => ({
      category: k.category,
      keywordCount: k.keywords.length
    })),
    mode: "enhanced_demo",
    version: "2.0"
  });
}

// app/api/ai-chat/route.js - å¢å¼ºç‰ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼ˆä¿®å¤ç‰ˆï¼‰
import { NextResponse } from 'next/server';


// å®‰å…¨ç”Ÿäº§çŸ¥è¯†åº“
const safetyKnowledge = [
  {
    id: 1,
    category: "å®‰å…¨ç”Ÿäº§æ³•",
    keywords: ["å®‰å…¨ç”Ÿäº§æ³•", "æ³•å¾‹", "æ³•è§„", "ä¸»ä½“è´£ä»»", "å®‰å…¨è´£ä»»åˆ¶"],
    content: `ã€Šå®‰å…¨ç”Ÿäº§æ³•ã€‹æ˜¯æˆ‘å›½å®‰å…¨ç”Ÿäº§é¢†åŸŸçš„åŸºæœ¬æ³•å¾‹ï¼Œäº2002å¹´é¦–æ¬¡å‘å¸ƒï¼Œ2021å¹´è¿›è¡Œäº†æœ€æ–°ä¿®è®¢ã€‚

**æ ¸å¿ƒå†…å®¹ï¼š**
â€¢ ç¡®ç«‹äº†"å®‰å…¨ç¬¬ä¸€ã€é¢„é˜²ä¸ºä¸»ã€ç»¼åˆæ²»ç†"çš„å®‰å…¨ç”Ÿäº§æ–¹é’ˆ
â€¢ æ˜ç¡®äº†ç”Ÿäº§ç»è¥å•ä½çš„ä¸»ä½“è´£ä»»
â€¢ è§„å®šäº†ä»ä¸šäººå‘˜çš„æƒåˆ©ä¹‰åŠ¡
â€¢ ç¡®å®šäº†æ”¿åºœåŠå…¶éƒ¨é—¨çš„ç›‘ç®¡èŒè´£

**ä¸»è¦è´Ÿè´£äººèŒè´£ï¼š**
â€¢ å»ºç«‹å¥å…¨æœ¬å•ä½å®‰å…¨ç”Ÿäº§è´£ä»»åˆ¶
â€¢ ç»„ç»‡åˆ¶å®šæœ¬å•ä½å®‰å…¨ç”Ÿäº§è§„ç« åˆ¶åº¦å’Œæ“ä½œè§„ç¨‹
â€¢ ç»„ç»‡åˆ¶å®šå¹¶å®æ–½æœ¬å•ä½å®‰å…¨ç”Ÿäº§æ•™è‚²å’ŒåŸ¹è®­è®¡åˆ’
â€¢ ä¿è¯æœ¬å•ä½å®‰å…¨ç”Ÿäº§æŠ•å…¥çš„æœ‰æ•ˆå®æ–½`
  },
  {
    id: 2,
    category: "é£é™©è¯„ä¼°",
    keywords: ["é£é™©è¯„ä¼°", "é£é™©è¯†åˆ«", "LEC", "é£é™©çŸ©é˜µ", "é£é™©ç­‰çº§"],
    content: `é£é™©è¯„ä¼°æ˜¯å®‰å…¨ç®¡ç†çš„æ ¸å¿ƒç¯èŠ‚ï¼Œé€šè¿‡ç³»ç»Ÿè¯†åˆ«ã€åˆ†æå’Œè¯„ä»·é£é™©ï¼Œä¸ºå®‰å…¨å†³ç­–æä¾›ç§‘å­¦ä¾æ®ã€‚

**é£é™©è¯„ä¼°æµç¨‹ï¼š**
1. **é£é™©è¯†åˆ«** - è¯†åˆ«ä½œä¸šæ´»åŠ¨ä¸­çš„å±é™©æº
2. **é£é™©åˆ†æ** - åˆ†æé£é™©å‘ç”Ÿçš„å¯èƒ½æ€§å’Œåæœä¸¥é‡ç¨‹åº¦  
3. **é£é™©è¯„ä»·** - ç¡®å®šé£é™©ç­‰çº§ï¼Œåˆ¤æ–­æ˜¯å¦å¯æ¥å—
4. **é£é™©æ§åˆ¶** - åˆ¶å®šé£é™©æ§åˆ¶æªæ–½

**å¸¸ç”¨è¯„ä¼°æ–¹æ³•ï¼š**
â€¢ **LECæ³•**ï¼šL(å¯èƒ½æ€§) Ã— E(æš´éœ²é¢‘ç‡) Ã— C(åæœä¸¥é‡æ€§)
â€¢ **é£é™©çŸ©é˜µæ³•**ï¼šå¯èƒ½æ€§ Ã— ä¸¥é‡ç¨‹åº¦
â€¢ **HAZOPæ³•**ï¼šå±é™©ä¸å¯æ“ä½œæ€§åˆ†æ

**é£é™©ç­‰çº§åˆ’åˆ†ï¼š**
â€¢ æé«˜é£é™©(çº¢è‰²)ï¼šç«‹å³åœæ­¢ä½œä¸šï¼Œé‡‡å–ç´§æ€¥æªæ–½
â€¢ é«˜é£é™©(æ©™è‰²)ï¼šéœ€è¦åˆ¶å®šè¯¦ç»†æ§åˆ¶æªæ–½
â€¢ ä¸­ç­‰é£é™©(é»„è‰²)ï¼šéœ€è¦å…³æ³¨å¹¶åˆ¶å®šæ§åˆ¶æªæ–½
â€¢ ä½é£é™©(ç»¿è‰²)ï¼šå¯æ¥å—ï¼Œä½†éœ€å®šæœŸå¤æŸ¥`
  },
  {
    id: 3,
    category: "åº”æ€¥ç®¡ç†",
    keywords: ["åº”æ€¥é¢„æ¡ˆ", "åº”æ€¥æ¼”ç»ƒ", "åº”æ€¥å“åº”", "äº‹æ•…å¤„ç½®"],
    content: `åº”æ€¥ç®¡ç†æ˜¯æŒ‡å¯¹çªå‘å®‰å…¨äº‹æ•…çš„é¢„é˜²ã€å‡†å¤‡ã€å“åº”å’Œæ¢å¤çš„å…¨è¿‡ç¨‹ç®¡ç†ã€‚

**åº”æ€¥é¢„æ¡ˆä½“ç³»ï¼š**
â€¢ **ç»¼åˆåº”æ€¥é¢„æ¡ˆ** - ä¼ä¸šæ€»ä½“åº”æ€¥ç­–ç•¥å’Œç¨‹åº
â€¢ **ä¸“é¡¹åº”æ€¥é¢„æ¡ˆ** - é’ˆå¯¹ç‰¹å®šé£é™©çš„ä¸“é—¨é¢„æ¡ˆ
â€¢ **ç°åœºå¤„ç½®æ–¹æ¡ˆ** - å…·ä½“ä½œä¸šåœºæ‰€çš„åº”æ€¥å¤„ç½®

**åº”æ€¥æ¼”ç»ƒè¦æ±‚ï¼š**
â€¢ **é¢‘æ¬¡**ï¼šç»¼åˆæ¼”ç»ƒæ¯å¹´è‡³å°‘1æ¬¡ï¼Œä¸“é¡¹æ¼”ç»ƒæ¯åŠå¹´è‡³å°‘1æ¬¡
â€¢ **ç±»å‹**ï¼šæ¡Œé¢æ¼”ç»ƒã€åŠŸèƒ½æ¼”ç»ƒã€å…¨é¢æ¼”ç»ƒ
â€¢ **è¯„ä¼°**ï¼šæ¼”ç»ƒæ•ˆæœè¯„ä¼°ï¼ŒåŠæ—¶ä¿®è®¢é¢„æ¡ˆ`
  },
  {
    id: 4,
    category: "éšæ‚£æ’æŸ¥",
    keywords: ["éšæ‚£æ’æŸ¥", "å®‰å…¨æ£€æŸ¥", "éšæ‚£æ²»ç†", "åŒé‡é¢„é˜²"],
    content: `éšæ‚£æ’æŸ¥æ²»ç†æ˜¯é¢„é˜²äº‹æ•…çš„é‡è¦æ‰‹æ®µï¼Œé€šè¿‡ç³»ç»Ÿæ’æŸ¥å’ŒåŠæ—¶æ²»ç†ï¼Œæ¶ˆé™¤å®‰å…¨éšæ‚£ã€‚

**éšæ‚£æ’æŸ¥åˆ¶åº¦ï¼š**
â€¢ **æ—¥å¸¸æ’æŸ¥** - å²—ä½å‘˜å·¥ç­å‰ç­ä¸­ç­åæ£€æŸ¥
â€¢ **å®šæœŸæ’æŸ¥** - ä¸“ä¸šäººå‘˜å‘¨æ£€æŸ¥ã€æœˆæ£€æŸ¥
â€¢ **ä¸“é¡¹æ’æŸ¥** - é’ˆå¯¹ç‰¹å®šæ—¶æœŸã€ç‰¹å®šé£é™©çš„æ£€æŸ¥
â€¢ **ç»¼åˆæ’æŸ¥** - å…¨é¢ç³»ç»Ÿçš„å®‰å…¨å¤§æ£€æŸ¥

**åŒé‡é¢„é˜²æœºåˆ¶ï¼š**
â€¢ **é£é™©åˆ†çº§ç®¡æ§** - è¶…å‰é˜²èŒƒï¼Œä»æºå¤´é¢„é˜²
â€¢ **éšæ‚£æ’æŸ¥æ²»ç†** - ç²¾å‡†æ²»ç†ï¼Œæœ‰æ•ˆåŒ–è§£é£é™©`
  },
  {
    id: 5,
    category: "å®‰å…¨åŸ¹è®­",
    keywords: ["å®‰å…¨åŸ¹è®­", "å®‰å…¨æ•™è‚²", "ä¸‰çº§æ•™è‚²", "ç‰¹ç§ä½œä¸š"],
    content: `å®‰å…¨åŸ¹è®­æ•™è‚²æ˜¯æé«˜ä»ä¸šäººå‘˜å®‰å…¨ç´ è´¨ï¼Œé˜²èŒƒäº‹æ•…å‘ç”Ÿçš„é‡è¦æ‰‹æ®µã€‚

**ä¸‰çº§å®‰å…¨æ•™è‚²ï¼š**
â€¢ **å‚çº§æ•™è‚²** - å®‰å…¨æ³•è§„ã€ä¼ä¸šå®‰å…¨åˆ¶åº¦ã€åŸºæœ¬å®‰å…¨çŸ¥è¯†(ä¸å°‘äº24å­¦æ—¶)
â€¢ **è½¦é—´çº§æ•™è‚²** - è½¦é—´å®‰å…¨åˆ¶åº¦ã€ä½œä¸šç¯å¢ƒã€å±é™©å› ç´ (ä¸å°‘äº16å­¦æ—¶)  
â€¢ **ç­ç»„çº§æ•™è‚²** - å²—ä½æ“ä½œè§„ç¨‹ã€å®‰å…¨æŠ€èƒ½ã€ä¸ªä½“é˜²æŠ¤(ä¸å°‘äº8å­¦æ—¶)

**ç‰¹ç§ä½œä¸šäººå‘˜è¦æ±‚ï¼š**
â€¢ **èŒƒå›´**ï¼šç”µå·¥ã€ç„Šå·¥ã€é«˜å¤„ä½œä¸šã€å±é™©åŒ–å­¦å“ç­‰
â€¢ **è¯ä¹¦**ï¼šå¿…é¡»æŒè¯ä¸Šå²—ï¼Œå®šæœŸå¤å®¡
â€¢ **åŸ¹è®­**ï¼šåˆè®­ä¸å°‘äº140å­¦æ—¶ï¼Œå¤è®­ä¸å°‘äº20å­¦æ—¶
â€¢ **è€ƒæ ¸**ï¼šç†è®ºè€ƒè¯•+å®é™…æ“ä½œï¼Œ80åˆ†ä»¥ä¸Šåˆæ ¼`
  },
  {
    id: 6,
    category: "é‡å¤§å±é™©æº",
    keywords: ["é‡å¤§å±é™©æº", "å±é™©æºè¾¨è¯†", "ç›‘æ§", "ä¸´ç•Œé‡"],
    content: `é‡å¤§å±é™©æºæ˜¯æŒ‡é•¿æœŸæˆ–ä¸´æ—¶ç”Ÿäº§ã€æ¬è¿ã€ä½¿ç”¨æˆ–è´®å­˜å±é™©ç‰©å“ï¼Œä¸”å±é™©ç‰©å“çš„æ•°é‡ç­‰äºæˆ–è¶…è¿‡ä¸´ç•Œé‡çš„å•å…ƒã€‚

**é‡å¤§å±é™©æºè¾¨è¯†ï¼š**
â€¢ **åˆ¤å®šæ ‡å‡†**ï¼šå±é™©ç‰©å“æ•°é‡â‰¥ä¸´ç•Œé‡
â€¢ **è®¡ç®—æ–¹æ³•**ï¼šâˆ‘(qâ‚/Qâ‚ + qâ‚‚/Qâ‚‚ + ... + qâ‚™/Qâ‚™) â‰¥ 1

**åˆ†çº§æ ‡å‡†ï¼š**
â€¢ **ä¸€çº§**ï¼šRâ‰¥100(æé«˜å±é™©)
â€¢ **äºŒçº§**ï¼š100>Râ‰¥50(é«˜åº¦å±é™©)  
â€¢ **ä¸‰çº§**ï¼š50>Râ‰¥10(ä¸­åº¦å±é™©)
â€¢ **å››çº§**ï¼šR<10(ä¸€èˆ¬å±é™©)

**å®‰å…¨ç®¡ç†è¦æ±‚ï¼š**
1. **å»ºç«‹ç®¡ç†åˆ¶åº¦** - å®‰å…¨ç®¡ç†åˆ¶åº¦ã€æ“ä½œè§„ç¨‹
2. **é…å¤‡å®‰å…¨è®¾æ–½** - ç›‘æµ‹ã€æŠ¥è­¦ã€è”é”ã€ç´§æ€¥åˆ‡æ–­ç­‰
3. **åˆ¶å®šåº”æ€¥é¢„æ¡ˆ** - ä¸“é¡¹åº”æ€¥é¢„æ¡ˆå’Œç°åœºå¤„ç½®æ–¹æ¡ˆ`
  }
];

// æ™ºèƒ½åŒ¹é…ç®—æ³•
function findBestMatch(question) {
  let bestMatches = [];
  
  for (const knowledge of safetyKnowledge) {
    let score = 0;
    const questionLower = question.toLowerCase();
    
    // å…³é”®è¯åŒ¹é…
    for (const keyword of knowledge.keywords) {
      if (questionLower.includes(keyword)) {
        score += 10;
      }
    }
    
    // åˆ†ç±»åŒ¹é…
    if (questionLower.includes(knowledge.category)) {
      score += 5;
    }
    
    if (score > 0) {
      bestMatches.push({ 
        knowledge, 
        score,
        matchInfo: `åŒ¹é…åˆ†æ•°: ${score.toFixed(1)}, ç±»åˆ«: ${knowledge.category}`
      });
    }
  }
  
  bestMatches.sort((a, b) => b.score - a.score);
  return bestMatches.slice(0, 2);
}

// ç”Ÿæˆå›ç­”
function generateAnswer(question, matches) {
  if (matches.length === 0) {
    return {
      answer: `æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•æ‰¾åˆ°å…³äº"${question}"çš„ç›¸å…³ä¿¡æ¯ã€‚

æˆ‘ç›®å‰çš„çŸ¥è¯†åº“æ¶µç›–ä»¥ä¸‹6ä¸ªå®‰å…¨ç”Ÿäº§é¢†åŸŸï¼š
â€¢ å®‰å…¨ç”Ÿäº§æ³•å¾‹æ³•è§„
â€¢ é£é™©è¯„ä¼°ä¸ç®¡æ§  
â€¢ åº”æ€¥ç®¡ç†
â€¢ éšæ‚£æ’æŸ¥æ²»ç†
â€¢ å®‰å…¨æ•™è‚²åŸ¹è®­
â€¢ é‡å¤§å±é™©æºç®¡ç†

å»ºè®®æ‚¨é‡æ–°æè¿°é—®é¢˜ï¼Œæˆ–è€…é€‰æ‹©ä¸Šè¿°é¢†åŸŸä¸­çš„å…·ä½“é—®é¢˜å’¨è¯¢ã€‚`,
      relatedTopics: ["å®‰å…¨ç”Ÿäº§æ³•", "é£é™©è¯„ä¼°", "åº”æ€¥ç®¡ç†"],
      matchScore: 0
    };
  }
  
  const bestMatch = matches[0];
  const knowledge = bestMatch.knowledge;
  
  let answer = `å…³äº"${question}"çš„ä¸“ä¸šå›ç­”ï¼š\n\n`;
  answer += knowledge.content;
  answer += `\n\nğŸ“‹ **ç›¸å…³è¦ç‚¹æé†’ï¼š**\n`;
  answer += `â€¢ æ‰€å±é¢†åŸŸï¼š${knowledge.category}\n`;
  answer += `â€¢ åŒ¹é…åº¦ï¼š${bestMatch.score.toFixed(1)}åˆ†\n`;
  
  if (matches.length > 1) {
    answer += `â€¢ ç›¸å…³é¢†åŸŸï¼š${matches[1].knowledge.category}\n`;
  }
  
  answer += `\nğŸ’¡ **å®æ–½å»ºè®®ï¼š**\n`;
  answer += `â€¢ ç»“åˆä¼ä¸šå®é™…æƒ…å†µåˆ¶å®šå…·ä½“æªæ–½\n`;
  answer += `â€¢ å®šæœŸæ£€æŸ¥å’Œæ›´æ–°ç›¸å…³åˆ¶åº¦\n`;
  answer += `â€¢ åŠ å¼ºåŸ¹è®­ï¼Œæé«˜å‘˜å·¥è®¤çŸ¥æ°´å¹³\n`;
  answer += `\nï¼ˆå½“å‰ä¸ºå¢å¼ºæ¼”ç¤ºæ¨¡å¼ï¼ŒåŸºäºä¸“ä¸šå®‰å…¨ç”Ÿäº§çŸ¥è¯†åº“ï¼‰`;
  
  return {
    answer,
    relatedTopics: [knowledge.category, ...(matches.length > 1 ? [matches[1].knowledge.category] : [])],
    matchScore: bestMatch.score
  };
}

// å¤„ç†POSTè¯·æ±‚
// å¤„ç†POSTè¯·æ±‚
export async function POST(request) {
  try {
    const { question } = await request.json();

    if (!question || question.trim().length === 0) {
      return NextResponse.json({
        success: false,
        error: 'é—®é¢˜ä¸èƒ½ä¸ºç©ºï¼Œè¯·è¾“å…¥æ‚¨çš„å®‰å…¨ç”Ÿäº§ç›¸å…³é—®é¢˜'
      }, { status: 400 });
    }

    console.log('æ”¶åˆ°é—®é¢˜:', question);

   if (true) {
      // å¢å¼ºæ¼”ç¤ºæ¨¡å¼
      const matches = findBestMatch(question);
      console.log(`æ‰¾åˆ° ${matches.length} ä¸ªåŒ¹é…é¡¹:`, matches.map(m => m.matchInfo));

      // æ¨¡æ‹Ÿæ€è€ƒæ—¶é—´
      await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 1000));

      const result = generateAnswer(question, matches);
      
      console.log(`ç”Ÿæˆå¢å¼ºå›ç­”ï¼Œé•¿åº¦: ${result.answer.length}, åŒ¹é…åˆ†æ•°: ${result.matchScore}`);

      return NextResponse.json({
        success: true,
        answer: result.answer,
        relatedTopics: result.relatedTopics,
        timestamp: new Date().toISOString(),
        tokensUsed: Math.floor(result.answer.length / 4),
        mode: "enhanced_demo",
        matchScore: result.matchScore
      });
    } else {
      // çœŸå®APIæ¨¡å¼ï¼ˆå½“éœ€è¦æ—¶ä½¿ç”¨ï¼‰
      return NextResponse.json({
        success: false,
        error: 'çœŸå®AIæ¨¡å¼æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼'
      }, { status: 503 });
    }

  } catch (error) {
    console.error('AI Chat APIé”™è¯¯:', error);
    return NextResponse.json({
      success: false,
      error: 'æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å›ç­”ï¼Œè¯·ç¨åå†è¯•'
    }, { status: 500 });
  }
}

// å¤„ç†GETè¯·æ±‚
export async function GET() {
  return NextResponse.json({
    message: "AIèŠå¤©API - å¢å¼ºæ¼”ç¤ºæ¨¡å¼",
    features: [
      "æ™ºèƒ½å…³é”®è¯åŒ¹é…",
      "6å¤§å®‰å…¨é¢†åŸŸçŸ¥è¯†åº“", 
      "è¯¦ç»†ä¸“ä¸šå›ç­”",
      "ç›¸å…³ä¸»é¢˜æ¨è",
      "åŒ¹é…åº¦è¯„åˆ†"
    ],
    knowledgeAreas: safetyKnowledge.map(k => ({
      category: k.category,
      keywordCount: k.keywords.length
    })),
    mode: "enhanced_demo",
    version: "2.0"
  });
}
